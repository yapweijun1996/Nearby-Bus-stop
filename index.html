<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Current Location and Locality</title>
    <!-- Include Leaflet CSS and JS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <h1>Get Your Current Location and Locality</h1>
    <div id="location"></div>
    <!-- Div for the map -->
    <div id="map" style="height: 400px; width: 100%;"></div>
    <script>
        // Function to fetch locality using BigDataCloud API
        function fetchLocality(lat, lon) {
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`)
                .then(response => response.json())
                .then(data => {
                    const locality = data.locality || 'Unknown';
                    document.getElementById('location').innerHTML += `<br>Locality: ${locality}`;
                })
                .catch(error => {
                    console.error('Error fetching locality:', error);
                    document.getElementById('location').innerHTML += `<br>Locality: Unable to fetch`;
                });
        }

        // Function to fetch nearby bus stops using Overpass API
        function fetchBusStops(lat, lon) {
            const query = `[out:json][timeout:25];
            (
              node["highway"="bus_stop"](around:1000, ${lat}, ${lon});
              node["public_transport"="platform"](around:1000, ${lat}, ${lon});
            );
            out body;
            >;
            out skel qt;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.elements.length === 0) {
                        document.getElementById('location').innerHTML += '<br>No bus stops found nearby.';
                    } else {
                        initializeMap(lat, lon, data.elements);
                    }
                })
                .catch(error => {
                    console.error('Error fetching bus stops:', error);
                    document.getElementById('location').innerHTML += '<br>Unable to fetch bus stops.';
                });
        }

        // Function to initialize the Leaflet map and add markers
        function initializeMap(lat, lon, busStops) {
            // Initialize map centered on user's location with zoom level 15
            const map = L.map('map').setView([lat, lon], 15);
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            // Add marker for user's location
            L.marker([lat, lon]).addTo(map).bindPopup('Your location').openPopup();
            // Add markers for each bus stop with bus stop code or ID
            busStops.forEach(stop => {
                const marker = L.marker([stop.lat, stop.lon]).addTo(map);
                // Look for bus stop code in 'ref' or 'local_ref', then fall back to 'name' or 'Bus stop'
                // const busStopId = stop.tags.ref || stop.tags.local_ref || stop.tags.name || 'Bus stop';
                const busStopId = stop.tags.ref +"<br>"+ stop.tags.name;
                marker.bindPopup(busStopId);
            });
        }

        // Check if the browser supports geolocation
        if (navigator.geolocation) {
            const options = {
                enableHighAccuracy: true,  // Use GPS for better accuracy
                timeout: 5000,            // Wait up to 5 seconds
                maximumAge: 0             // Don’t use cached data
            };
            // Request the user's current position
            navigator.geolocation.getCurrentPosition(showPosition, showError, options);
        } else {
            document.getElementById('location').innerHTML = "Geolocation is not supported by this browser.";
        }

        // Handle successful geolocation response
        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            // Display coordinates
            document.getElementById('location').innerHTML = `Latitude: ${latitude}<br>Longitude: ${longitude}`;
            // Fetch locality and bus stops
            fetchLocality(latitude, longitude);
            fetchBusStops(latitude, longitude);
        }

        // Handle geolocation errors
        function showError(error) {
            let message;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message = "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "An unknown error occurred.";
                    break;
            }
            document.getElementById('location').innerHTML = message;
        }
    </script>
</body>
</html>